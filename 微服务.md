# 微服务架构风格

## 定义：
1. 一些列的独立的服务共同组成系统
2. 单独部署，跑在自己的进程里
3. 每个服务为独立的业务开发
4. 分布式的管理

- X：水平克隆
- Y：功能分解
- Z：分表分区

衡量标准：单一职责模式（SRP）是一种很好的衡量标准。

**智能化端点与傻瓜式流程。旨在尽可能实现解耦化与关联性--它们各自拥有自己的域逻辑**

## 优点：

（相对应钢板一块的应用）
- 规模伸缩（拷贝）
- 稳定性高（异常和调整代码控制在一个服务内）
- 扩展性强（服务间功能相对独立，松耦合）

## 挑战：

- 多服务运维难度
- 服务间通信成本
- 数据一致性
- 性能监控 

## 实施：

**（API Gateway功能：服务注册、发现、负载均衡和健康检查）**

1. 客户端如何访问服务：透过API Gateway代理。
    - 统一访问入口
    - 聚合后台服务，节省流量，提升性能
    - 提供安全，过滤，流控等API管理功能 
2. 服务间如何通讯：
    - 同步：REST、RPC
        - 简单，一致性强，但是容易出调用问题，性能体验上也会差些
    - 异步：消息调用
        - 减低调用服务之间的耦合，又能成为调用之间的缓冲
        - 付出的代价是一致性的减弱，需要接受数据最终一致性
        - 注意：
            1. 幂等（保证消息的被收到且仅收到一次对性能是很大的考验）
            2. 顺序（竞争资源）
3. 服务发现：（一个服务会有多个拷贝，有可能随时下线）
    - 服务注册/维持心跳长链接 OR 弹性负载均衡
4. 服务挂了：
    - 重试、限流、负载均衡……

### 细节：事件驱动 + 消息队列 实现分布式事务

事件持久化：可溯源
1. EventPublish
    - id
    - status
    - payload
    - createTime
    - eventType
2. EventProcess
    - id
    - status
    - payload
    - createTime
    - eventType

原子性保障：
本地事务 +事件持久化+ 消息队列

三段式：
- A：
    - A事件触发
        - A业务处理
        - A事件发布持久化
        - A消息发布
- B：
    - A消息订阅
        - B业务处理
        - B事件接收持久化
        - B事件触发
- A：
    - B事件监听
        - A业务处理（算是对B业务的确认）
        - A事件接收持久化

- 利用本地服务有限数据冗余
- 定时任务
- 一对多的发布、订阅
